<%- layout("layouts/dashboard-layout.ejs") %>

<!-- Dashboard Overview -->
<div class="row g-4">
  <!-- Welcome Card -->
  <div class="col-12">
    <div class="card border-0 shadow-sm">
      <div class="card-body p-4">
        <div class="d-flex align-items-center">
          <div class="avatar-large bg-primary bg-gradient text-white">
            <%= user.FirstName.charAt(0).toUpperCase() %><%=
            user.LastName.charAt(0).toUpperCase() %>
          </div>
          <div class="ms-3">
            <h3 class="mb-1">Welcome back, <%= user.FirstName %>!</h3>
            <p class="text-muted mb-0">
              Here's an overview of your scholarship journey
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="col-md-6 col-lg-3">
    <div class="card stat-card border-0 shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex align-items-center">
          <div class="stat-icon bg-primary bg-opacity-10 text-primary">
            <i class="bi bi-bookmark-heart-fill"></i>
          </div>
          <div class="ms-3">
            <h2 class="mb-0">
              <%= userInfo && userInfo.savedScholarships ?
              userInfo.savedScholarships.length : 0 %>
            </h2>
            <p class="text-muted mb-0 small">Saved Scholarships</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-6 col-lg-3">
    <div class="card stat-card border-0 shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between">
          <div class="d-flex align-items-center">
            <div class="stat-icon bg-success bg-opacity-10 text-success">
              <i class="bi bi-file-earmark-check-fill"></i>
            </div>
            <div class="ms-3">
              <h2 class="mb-0">
                <%= userInfo && userInfo.applicationsSubmitted ?
                userInfo.applicationsSubmitted : 0 %>
              </h2>
              <p class="text-muted mb-0 small">Applications</p>
            </div>
          </div>
          <button
            class="btn btn-sm btn-outline-success edit-applications-btn"
            title="Edit applications count"
          >
            <i class="bi bi-pencil"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Profile Completion -->
  <div class="col-lg-8">
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-white border-0 py-3">
        <h5 class="mb-0">Profile Completion</h5>
      </div>
      <div class="card-body">
        <% 
          let completionPercentage = 40;
          if (userInfo && userInfo.dateOfBirth) completionPercentage += 10;
          if (userInfo && userInfo.gender) completionPercentage += 10;
          if (userInfo && userInfo.educationLevel) completionPercentage += 20;
          if (userInfo && userInfo.state) completionPercentage += 10;
          if (userInfo && userInfo.city) completionPercentage += 10;
        %>
        <div class="d-flex justify-content-between align-items-center mb-2">
          <span class="text-muted"
            >Your profile is <%= completionPercentage %>% complete</span
          >
          <span class="fw-bold text-primary"><%= completionPercentage %>%</span>
        </div>
        <div class="progress" style="height: 12px">
          <div
            class="progress-bar bg-primary bg-gradient"
            role="progressbar"
            style="width: <%= completionPercentage %>%"
            aria-valuenow="<%= completionPercentage %>"
            aria-valuemin="0"
            aria-valuemax="100"
          ></div>
        </div>
        <% if (completionPercentage < 100) { %>
        <div class="mt-3">
          <p class="text-muted mb-2 small">
            Complete your profile to unlock all features:
          </p>
          <a href="/profile" class="btn btn-primary btn-sm">
            <i class="bi bi-pencil-square me-1"></i> Complete Profile
          </a>
        </div>
        <% } %>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="card border-0 shadow-sm mt-4">
      <div class="card-header bg-white border-0 py-3">
        <h5 class="mb-0">Quick Actions</h5>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <a href="/scholarships" class="quick-action-card">
              <div
                class="quick-action-icon bg-primary bg-opacity-10 text-primary"
              >
                <i class="bi bi-search"></i>
              </div>
              <div class="ms-3">
                <h6 class="mb-1">Browse Scholarships</h6>
                <small class="text-muted"
                  >Find scholarships that match your profile</small
                >
              </div>
            </a>
          </div>
          <div class="col-md-6">
            <a href="/profile" class="quick-action-card">
              <div
                class="quick-action-icon bg-success bg-opacity-10 text-success"
              >
                <i class="bi bi-person-fill-gear"></i>
              </div>
              <div class="ms-3">
                <h6 class="mb-1">Update Profile</h6>
                <small class="text-muted"
                  >Keep your information up to date</small
                >
              </div>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Account Information -->
  <div class="col-lg-4">
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-white border-0 py-3">
        <h5 class="mb-0">Account Information</h5>
      </div>
      <div class="card-body">
        <div class="info-item">
          <i class="bi bi-person text-primary"></i>
          <div class="ms-3">
            <small class="text-muted d-block">Full Name</small>
            <span class="fw-semibold"
              ><%= user.FirstName %> <%= user.LastName %></span
            >
          </div>
        </div>
        <div class="info-item">
          <i class="bi bi-envelope text-primary"></i>
          <div class="ms-3">
            <small class="text-muted d-block">Email</small>
            <span class="fw-semibold"><%= user.Email %></span>
          </div>
        </div>
        <div class="info-item">
          <i class="bi bi-phone text-primary"></i>
          <div class="ms-3">
            <small class="text-muted d-block">Mobile</small>
            <span class="fw-semibold"><%= user.Mobile %></span>
          </div>
        </div>
        <% if (userInfo && userInfo.educationLevel) { %>
        <div class="info-item">
          <i class="bi bi-mortarboard text-primary"></i>
          <div class="ms-3">
            <small class="text-muted d-block">Education Level</small>
            <span class="fw-semibold"><%= userInfo.educationLevel %></span>
          </div>
        </div>
        <% } %> <% if (userInfo && userInfo.state) { %>
        <div class="info-item">
          <i class="bi bi-geo-alt text-primary"></i>
          <div class="ms-3">
            <small class="text-muted d-block">Location</small>
            <span class="fw-semibold"
              ><%= userInfo.city %>, <%= userInfo.state %></span
            >
          </div>
        </div>
        <% } %>
      </div>
    </div>

    <!-- Tips Card -->
    <div class="card border-0 shadow-sm mt-4 bg-light">
      <div class="card-body">
        <div class="d-flex align-items-start">
          <i class="bi bi-lightbulb-fill text-warning fs-3 me-3"></i>
          <div>
            <h6 class="mb-2">Pro Tip!</h6>
            <p class="small text-muted mb-0">
              Complete your profile to receive personalized scholarship
              recommendations based on your qualifications.
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Edit Applications Modal -->
<div class="modal fade" id="editApplicationsModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Update Applications Submitted</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="applicationsInput" class="form-label"
            >Number of Applications Submitted</label
          >
          <input
            type="number"
            class="form-control"
            id="applicationsInput"
            value="<%= userInfo && userInfo.applicationsSubmitted ? userInfo.applicationsSubmitted : 0 %>"
            min="0"
            placeholder="Enter number of applications"
          />
        </div>
        <div id="applicationError" class="alert alert-danger d-none"></div>
        <div id="applicationSuccess" class="alert alert-success d-none"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
        <button type="button" class="btn btn-primary" id="saveApplicationsBtn">
          Save Changes
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  // Wait for DOM to be ready
  document.addEventListener("DOMContentLoaded", function () {
    // Handle edit applications button
    const editBtn = document.querySelector(".edit-applications-btn");
    if (editBtn) {
      editBtn.addEventListener("click", () => {
        const modal = new bootstrap.Modal(
          document.getElementById("editApplicationsModal")
        );
        modal.show();
      });
    }

    // Handle save applications button
    const saveBtn = document.getElementById("saveApplicationsBtn");
    if (saveBtn) {
      saveBtn.addEventListener("click", async () => {
        const applicationsInput = document.getElementById("applicationsInput");
        const errorDiv = document.getElementById("applicationError");
        const successDiv = document.getElementById("applicationSuccess");

        // Clear previous messages
        errorDiv.classList.add("d-none");
        successDiv.classList.add("d-none");

        const applicationsCount = applicationsInput.value;

        // Validate input
        if (applicationsCount === "" || applicationsCount < 0) {
          errorDiv.textContent = "Please enter a valid number of applications";
          errorDiv.classList.remove("d-none");
          return;
        }

        try {
          const response = await fetch("/update-applications", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              applicationsSubmitted: parseInt(applicationsCount),
            }),
          });

          const data = await response.json();

          if (data.success) {
            successDiv.textContent = data.message;
            successDiv.classList.remove("d-none");

            // Update the display on the page
            const statsCard = document.querySelector(".stat-card .ms-3 h2");
            if (statsCard) {
              statsCard.textContent = data.applicationsSubmitted;
            }

            // Close modal after 1.5 seconds
            setTimeout(() => {
              const modal = bootstrap.Modal.getInstance(
                document.getElementById("editApplicationsModal")
              );
              if (modal) {
                modal.hide();
              }
            }, 1500);
          } else {
            errorDiv.textContent = data.message;
            errorDiv.classList.remove("d-none");
          }
        } catch (e) {
          errorDiv.textContent = "Error updating applications: " + e.message;
          errorDiv.classList.remove("d-none");
        }
      });
    }

    // Handle Enter key in input field
    const applicationsInput = document.getElementById("applicationsInput");
    if (applicationsInput) {
      applicationsInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          document.getElementById("saveApplicationsBtn").click();
        }
      });
    }
  });
</script>
